name: Build PaddleOCR C++ (Linux CPU)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
  pull_request:
    branches: [ main ]

# https://www.paddleocr.ai/main/version3.x/deployment/cpp/OCR.html
jobs:
  build:
    # https://docs.github.com/en/actions/concepts/runners/github-hosted-runners
    # https://github.com/actions/runner-images
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        # å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…·
        sudo apt-get install -y build-essential cmake git pkg-config yasm nasm wget unzip tree
        # OpenCV ä¾èµ– (ç”¨äºæºç ç¼–è¯‘)
        sudo apt-get install -y libgtk2.0-dev libavcodec-dev libavformat-dev
        sudo apt-get install -y libswscale-dev libjpeg-dev libpng-dev libtiff-dev libopenjp2-7-dev libhdf5-dev
        # Freetype/Harfbuzz ä¾èµ– (ç”¨äº OpenCV ç»˜åˆ¶ä¸­æ–‡)
        sudo apt-get install -y libfreetype6-dev libharfbuzz-dev libssl-dev
        python3 -m pip install --upgrade pip
        python3 -m pip install numpy setuptools wheel
    
    - name: Show working directory and disk info
      run: |
        tree ${{ github.workspace }}
        df -h ${{ github.workspace }}
        df -h
        python --version
        cmake --version
    
    # -----------------------------------------------------------------------
    # æ„å»º OpenCV (é™æ€åº“ + Freetype æ”¯æŒ)
    # -----------------------------------------------------------------------
    # ä½¿ç”¨ Cache åœ¨ä¸åŒ Jobã€Workflow Run ä¹‹é—´å…±äº«æ–‡ä»¶ï¼Œæ€»å®¹é‡æœ€å¤§10GBï¼Œ7å¤©å†…è¦è®¿é—®åˆ°ä¸€æ¬¡ï¼Œå¦åˆ™ä¼šè¢«æ¸…ç†
    #- name: Cache OpenCV Build
    #  id: cache-opencv
    #  uses: actions/cache@v3
    #  with:
    #    # åç»­ä½¿ç”¨${{ github.workspace }}è·å–æ ¹ç›®å½•
    #    path: opencv_install
    #    # echo "hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
    #    # æˆ–è€…ç”¨æ•´ä¸ªç›®å½•å†…å®¹ hashï¼ˆå¦‚æœé gitï¼‰
    #    # echo "hash=$(find . -type f -exec sha256sum {} \; | sha2516sum | cut -d' ' -f1)" >> $GITHUB_OUTPUT
    #    # ${{ hashFiles('opencv_source/*') }}
    #    key: ${{ runner.os }}-opencv-4.7.0-${{ steps.opencv-hash.outputs.hash }}

    - name: Build OpenCV 4.7.0
      #if: steps.cache-opencv.outputs.cache-hit != 'true'
      run: |
        root_path="opencv"
        rm -rf ${root_path}
        mkdir ${root_path}
        cd ${root_path}
        
        OPENCV_VER="4.7.0"
        
        git clone https://github.com/opencv/opencv.git opencv_source -b ${OPENCV_VER} --depth 1
        # ä¸‹è½½ opencv_contrib ä»¥æ”¯æŒ freetype (è§£å†³ä¸­æ–‡ä¹±ç )
        git clone https://github.com/opencv/opencv_contrib.git opencv_contrib -b ${OPENCV_VER} --depth 1
        
        # ä¸‹è½½ Core å’Œ Contrib (Contrib åŒ…å« freetype æ¨¡å—)
        #wget -q https://github.com/opencv/opencv/archive/${OPENCV_VER}.zip -O opencv.zip
        #unzip -q opencv.zip && mv opencv-${OPENCV_VER} opencv_source
        #wget -q https://github.com/opencv/opencv_contrib/archive/${OPENCV_VER}.zip -O opencv_contrib.zip
        #unzip -q opencv_contrib.zip && mv opencv_contrib-${OPENCV_VER} opencv_contrib
        
        OPENCV_INSTALL_DIR="${{ github.workspace }}/${root_path}/install"
        echo "OPENCV_INSTALL_DIR=${OPENCV_INSTALL_DIR}" >> $GITHUB_ENV
                
        # https://github.com/PaddlePaddle/PaddleOCR/raw/refs/heads/main/deploy/cpp_infer/tools/build_opencv.sh
        # CMake â‰¥ 3.13.0
        # -S <path-to-source>ï¼šæŒ‡å®šæºç æ ¹ç›®å½•ï¼ˆå³åŒ…å« CMakeLists.txt çš„é¡¶çº§ç›®å½•ï¼‰
        # -B <path-to-build>ï¼šæŒ‡å®šæ„å»ºç›®å½•ï¼ˆç”Ÿæˆçš„å·¥ç¨‹æ–‡ä»¶å­˜æ”¾ä½ç½®ï¼‰
        cmake -S opencv_source -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=${OPENCV_INSTALL_DIR} \
          -DOPENCV_EXTRA_MODULES_PATH=opencv_contrib/modules \
          -DBUILD_SHARED_LIBS=ON \
          -DCMAKE_INSTALL_LIBDIR=lib64 \
          -DWITH_FREETYPE=ON \
          -DBUILD_opencv_freetype=ON \
          -DWITH_GTK=ON \
          -DWITH_QT=OFF \
          -DWITH_OPENGL=OFF \
          -DWITH_MKL=OFF \
          -DWITH_CUDA=OFF \
          \
          -DBUILD_TESTS=OFF \
          -DBUILD_PERF_TESTS=OFF \
          -DBUILD_EXAMPLES=OFF \
          -DBUILD_opencv_sfm=OFF \
          -DBUILD_opencv_apps=OFF \
          -DBUILD_opencv_gapi=OFF \
          \
          -DBUILD_opencv_python2=OFF \
          -DBUILD_opencv_python3=ON \
          -DWITH_PYTHON=ON \
          -DBUILD_JAVA=ON \
          -DBUILD_opencv_java=ON \
          \
          -DWITH_IPP=OFF \
          -DBUILD_IPP_IW=OFF \
          -DWITH_LAPACK=OFF \
          -DWITH_EIGEN=OFF \
          \
          -DWITH_ZLIB=ON \
          -DBUILD_ZLIB=ON \
          -DWITH_JPEG=ON \
          -DBUILD_JPEG=ON \
          -DWITH_PNG=ON \
          -DBUILD_PNG=ON \
          -DWITH_TIFF=ON \
          -DBUILD_TIFF=ON
        
        #cmake --build build --parallel $(nproc)
        #cmake --install build
        cd build
        make -j$(nproc)
        make install
        cd -
        
        # æ¸…ç†ä»¥èŠ‚çœç©ºé—´
        rm -rf opencv_source opencv_contrib *.zip
    
    - name: Show OpenCV directory
      run: |
        tree ${{ github.workspace }}/opencv
    
    # -----------------------------------------------------------------------
    # ä»æºç ç¼–è¯‘ https://www.paddlepaddle.org.cn/inference/v3.0/guides/install/compile/source_compile_under_Linux.html
    # git clone https://github.com/PaddlePaddle/Paddle.git paddle_source -b release/3.3 --depth 1
    
    # ä¸‹è½½å®˜æ–¹é¢„ç¼–è¯‘ Paddle Inference åº“ (æ¨èï¼Œé€Ÿåº¦å¿«)
    # -----------------------------------------------------------------------
    - name: Download Paddle Inference Library (Linux CPU)
      run: |
        # ä¸‹è½½ Paddle Inference (GCC 8.2, CPU, MKL/OpenBLAS)
        # https://www.paddlepaddle.org.cn/inference/v3.0/guides/install/download_lib.html
        wget -q https://paddle-inference-lib.bj.bcebos.com/3.2.2/cxx_c/Linux/CPU/gcc8.2_avx_mkl/paddle_inference.tgz
        
        tar -xf paddle_inference.tgz
        
        echo "PADDLE_LIB_DIR=$(pwd)/paddle_inference" >> $GITHUB_ENV
        
        # éªŒè¯
        tree paddle_inference/paddle/lib
        
    
    # -----------------------------------------------------------------------
    # ç¼–è¯‘ PaddleOCR C++ Demo
    # å‚è€ƒæ–‡æ¡£: https://www.paddleocr.ai/main/version3.x/deployment/cpp/OCR.html#step-2
    # -----------------------------------------------------------------------
    #- name: Clone PaddleOCR
    #  uses: actions/checkout@v4
    #  with:
    #    repository: PaddlePaddle/PaddleOCR
    #    ref: v3.3.2
    #    path: PaddleOCR
    
    - name: Build PaddleOCR C++ Demo
      run: |
        git clone https://github.com/PaddlePaddle/PaddleOCR.git -b release/3.3 --depth 1
        
        CPP_INFER_DIR="$(pwd)/PaddleOCR/deploy/cpp_infer"
        echo "CPP_INFER_DIR=${CPP_INFER_DIR}" >> $GITHUB_ENV
        cd ${CPP_INFER_DIR}
        
        # https://github.com/PaddlePaddle/PaddleOCR/raw/refs/heads/main/deploy/cpp_infer/tools/build.sh
        # CMake â‰¥ 3.13.0
        # -S <path-to-source>ï¼šæŒ‡å®šæºç æ ¹ç›®å½•ï¼ˆå³åŒ…å« CMakeLists.txt çš„é¡¶çº§ç›®å½•ï¼‰
        # -B <path-to-build>ï¼šæŒ‡å®šæ„å»ºç›®å½•ï¼ˆç”Ÿæˆçš„å·¥ç¨‹æ–‡ä»¶å­˜æ”¾ä½ç½®ï¼‰
        # WITH_MKL=ON: å¿…é¡»å¼€å¯ï¼Œå› ä¸ºä¸‹è½½çš„ inference lib æ˜¯ MKL ç‰ˆ
        cmake -S . -B build \
          -DPADDLE_LIB=${{ env.PADDLE_LIB_DIR }} \
          -DCMAKE_PREFIX_PATH=${{ env.OPENCV_INSTALL_DIR }} \
          -DOPENCV_DIR=${{ env.OPENCV_INSTALL_DIR }}/lib64/cmake/opencv4 \
          -DWITH_MKL=ON \
          -DWITH_GPU=OFF \
          -DWITH_STATIC_LIB=OFF \
          -DWITH_TENSORRT=OFF \
        #  -DUSE_FREETYPE=ON \
          -DCMAKE_BUILD_TYPE=Release
        
        #cmake --build build --parallel $(nproc)
        #cmake --install build
        cd build
        make -j$(nproc)
        #make install
        #cd -
        
        # éªŒè¯ç”Ÿæˆ
        ls -lh ppocr
        ./ppocr --help || echo "Help menu check"
    
    # -----------------------------------------------------------------------
    # æ‰“åŒ…å‘å¸ƒ
    # -----------------------------------------------------------------------
    - name: Prepare Artifacts
      run: |
        PKG_NAME="paddleocr-linux-cpu-cpp"
        mkdir -p ${PKG_NAME}/lib
        mkdir -p ${PKG_NAME}/config
        
        BASE_DIR=${PKG_NAME}
        
        # 1. å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        cp ${{ env.CPP_INFER_DIR }}/build/ppocr ${BASE_DIR}/
        
        # 2. å¤åˆ¶é…ç½®å’Œèµ„æºæ–‡ä»¶
        cp ${{ env.CPP_INFER_DIR }}/tools/config.txt ${BASE_DIR}/config/ || true
        cp ${{ env.CPP_INFER_DIR }}/tools/*.txt ${BASE_DIR}/ || true
        
        # 3. å¤åˆ¶ Paddle ä¾èµ–åº“ (.so)
        # Paddle æ ¸å¿ƒåº“
        cp -L ${{ env.PADDLE_LIB_DIR }}/paddle/lib/*.so* ${BASE_DIR}/lib/
        # ç¬¬ä¸‰æ–¹åº“ (MKL, MKLDNN, IOMP5 ç­‰)
        # Paddle ç»“æ„ä¸­ third_party é€šå¸¸åŒ…å«è¿™äº›
        THIRD_PARTY="${{ env.PADDLE_LIB_DIR }}/third_party/install"
        [ -d "${THIRD_PARTY}/mklml/lib" ] && cp -L ${THIRD_PARTY}/mklml/lib/*.so* ${BASE_DIR}/lib/
        [ -d "${THIRD_PARTY}/mkldnn/lib" ] && cp -L ${THIRD_PARTY}/mkldnn/lib/*.so* ${BASE_DIR}/lib/
        # æœ‰æ—¶å€™ iomp5 åœ¨ mklml é‡Œï¼Œæœ‰æ—¶å•ç‹¬
        find ${THIRD_PARTY} -name "libiomp5.so" -exec cp {} ${BASE_DIR}/lib/ \;
        
        # 4. å¤åˆ¶ OpenCV åº“
        cp -L ${{ env.OPENCV_INSTALL_DIR }}/lib/*.so* ${BASE_DIR}/lib/
        
        # 5. åˆ›å»ºå¯åŠ¨è„šæœ¬ run.sh (è‡ªåŠ¨è®¾ç½® LD_LIBRARY_PATH)
        echo '#!/bin/bash' > ${BASE_DIR}/run.sh
        echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(dirname "$(readlink -f "$0")")/lib' >> $BASE_DIR/run.sh
        echo './ppocr "$@"' >> ${BASE_DIR}/run.sh
        chmod +x ${BASE_DIR}/run.sh
        
        echo "Artifacts packed in ${BASE_DIR}"
    
  #  - name: Upload build artifacts
  #    uses: actions/upload-artifact@v4
  #    with:
  #      name: paddleocr-cpp-linux-build
  #      path: release_package/
  #      retention-days: 7
  #  
  #release:
  #  needs: build
  #  if: github.event_name == 'workflow_dispatch'
  #  runs-on: ubuntu-latest
  #  permissions:
  #    contents: write
  #  steps:
  #  - name: Download build artifacts
  #    uses: actions/download-artifact@v4
  #    with:
  #      path: release_package/
  #      pattern: paddleocr-cpp-linux-build

    - name: Zip artifacts for release
      if: github.event_name == 'workflow_dispatch'
      run: |
        cd release_package
        zip -r ../paddleocr-linux-${{ github.event.inputs.version }}.zip . --exclude "*.git*"
    
    - name: Create GitHub Release
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: PaddleOCR C++ Linux Build ${{ github.event.inputs.version }}
        body: |
          ## PaddleOCR C++ Linux (Ubuntu 20.04) Build
          
          Built following official v3.x documentation.
          
          ### Requirements
          - **PaddleOCR Version**: [v3.3.2](https://github.com/PaddlePaddle/PaddleOCR/releases/tag/v3.3.2)
          - **Paddle Inference**: 3.2.2 (GCC 8.2 / AVX / MKL)
          - **OpenCV**: 4.7.0 (Compiled with Freetype & GTK)
          - **OS**: Ubuntu 20.04
          
          ### ğŸš€ How to Run
          
          1. Download and unzip `paddleocr-linux-${{ github.event.inputs.version }}.zip`.
          2. Use the `run.sh` script (no need to install libraries manually):
          
          ```bash
          # Basic usage
          ./run.sh system --image_dir=./path/to/image --det_model_dir=...
          
          # View help
          ./run.sh --help
          ```
        files: paddleocr-linux-${{ github.event.inputs.version }}.zip
