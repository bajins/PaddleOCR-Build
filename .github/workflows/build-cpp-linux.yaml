name: Build PaddleOCR C++ (Linux CPU with Static OpenCV & Prebuilt Paddle Inference)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
  pull_request:
    branches: [ main ]

# https://www.paddleocr.ai/main/version3.x/deployment/cpp/OCR.html
jobs:
  build:
    # 使用 ubuntu-20.04或ubuntu-18.04
    # 原因: Paddle Inference 2.6.1 依赖 OpenSSL 1.1，而 ubuntu-22.04 默认是 OpenSSL 3.0，会导致运行时崩溃。
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        # 安装基础编译工具
        sudo apt-get install -y build-essential cmake git pkg-config
        # OpenCV 依赖 (用于源码编译)
        sudo apt-get install -y libgtk2.0-dev libavcodec-dev libavformat-dev libswscale-dev
        # Freetype/Harfbuzz 依赖 (用于 OpenCV 绘制中文)
        sudo apt-get install -y libfreetype6-dev libharfbuzz-dev libssl-dev wget unzip

    # -----------------------------------------------------------------------
    # 选项 A: 下载官方预编译 Paddle Inference 库 (推荐，速度快)
    # -----------------------------------------------------------------------
    - name: Download Paddle Inference Library (Linux CPU)
      run: |
        mkdir -p paddle_inference_lib
        cd paddle_inference_lib
        # 下载 Paddle Inference (GCC 8.2, CPU, MKL/OpenBLAS)
        # https://www.paddlepaddle.org.cn/inference/v3.0/guides/install/download_lib.html
        wget -q https://paddle-inference-lib.bj.bcebos.com/3.2.2/cxx_c/Linux/CPU/gcc8.2_avx_mkl/paddle_inference.tgz
        tar -xf paddle_inference.tgz
        # 结构通常是: paddle_inference/paddle/lib
        echo "PADDLE_LIB_DIR=$(pwd)/paddle_inference" >> $GITHUB_ENV
        # 验证
        ls -R paddle_inference/paddle/lib

    # -----------------------------------------------------------------------
    # 选项 B: 从源码编译 Paddle Inference (如果不使用预编译库，取消下方注释)
    # 注意: 在 GitHub Actions 免费 runner 上极易超时或内存溢出
    # https://www.paddlepaddle.org.cn/inference/v3.0/guides/install/compile/source_compile_under_Linux.html
    # -----------------------------------------------------------------------
    # - name: Clone Paddle Source
    #   run: |
    #     git clone https://github.com/PaddlePaddle/Paddle.git paddle_source
    #     cd paddle_source
    #     git checkout release/3.2.2
    #
    # - name: Build Paddle Inference from Source
    #   working-directory: paddle_source
    #   run: |
    #     mkdir build && cd build
    #     cmake .. \
    #       -DWITH_GPU=OFF \
    #       -DWITH_MKL=ON \
    #       -DWITH_TENSORRT=OFF \
    #       -DON_INFER=ON \
    #       -DWITH_PYTHON=OFF \
    #       -DCMAKE_BUILD_TYPE=Release
    #     make -j$(nproc)
    #     make inference_lib_dist
    #     echo "PADDLE_LIB_DIR=$(pwd)/paddle_inference" >> $GITHUB_ENV

    # -----------------------------------------------------------------------
    # 构建 OpenCV (静态库 + Freetype 支持)
    # -----------------------------------------------------------------------
    - name: Cache OpenCV Build
      id: cache-opencv
      uses: actions/cache@v3
      with:
        path: opencv_install
        key: ${{ runner.os }}-opencv-4.7.0-freetype-v2

    - name: Clone and Build OpenCV 4.7.0 (Static with Freetype)
      if: steps.cache-opencv.outputs.cache-hit != 'true'
      run: |
        git clone https://github.com/opencv/opencv.git opencv_source -b 4.7.0 --depth 1
        # 下载 opencv_contrib 以支持 freetype (解决中文乱码)
        git clone https://github.com/opencv/opencv_contrib.git opencv_contrib -b 4.7.0 --depth 1
        
        mkdir -p opencv_build
        cd opencv_build
        
        cmake ../opencv_source \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/opencv_install \
          -DOPENCV_EXTRA_MODULES_PATH=../opencv_contrib/modules \
          -DBUILD_SHARED_LIBS=ON \
          -DWITH_FREETYPE=ON \
          -DBUILD_TESTS=OFF \
          -DBUILD_PERF_TESTS=OFF \
          -DBUILD_EXAMPLES=OFF \
          -DWITH_QT=OFF \
          -DWITH_GTK=ON
        
        make -j$(nproc)
        make install

    # -----------------------------------------------------------------------
    # 步骤 3: 编译 PaddleOCR C++ Demo
    # 参考文档: https://www.paddleocr.ai/main/version3.x/deployment/cpp/OCR.html#step-2
    # -----------------------------------------------------------------------
    - name: Clone PaddleOCR
      run: |
        git clone https://github.com/PaddlePaddle/PaddleOCR.git
        cd PaddleOCR
        git checkout release/3.3.2
        
    - name: Configure and Build PaddleOCR C++ Demo
      run: |
        cd PaddleOCR/deploy/cpp_infer
        
        # 如果使用的是预编译库，库结构可能略有不同
        # 预编译库路径: $PADDLE_LIB_DIR/paddle/lib/libpaddle_inference.so
        # OpenCV 路径: ${{ github.workspace }}/opencv_install
        
        mkdir -p build
        cd build
        
        # PADDLE_LIB: 指向 paddle_inference 文件夹根目录
        # OPENCV_DIR: 指向包含 OpenCVConfig.cmake 的文件夹
        cmake .. \
          -DPADDLE_LIB=${{ env.PADDLE_LIB_DIR }} \
          -DWITH_MKL=ON \
          -DWITH_GPU=OFF \
          -DWITH_STATIC_LIB=OFF \
          -DWITH_TENSORRT=OFF \
          -DOPENCV_DIR=${{ github.workspace }}/opencv_install/lib/cmake/opencv4 \
          -DCMAKE_BUILD_TYPE=Release

        make -j$(nproc)
        
        # 验证生成
        ls -lh ppocr
        ./ppocr --help || echo "Binary built, showing help message logic"

    # -----------------------------------------------------------------------
    # 打包发布
    # -----------------------------------------------------------------------
    - name: Prepare Artifacts
      run: |
        mkdir -p release_package/lib
        
        # 1. 可执行文件
        cp PaddleOCR/deploy/cpp_infer/build/ppocr release_package/
        
        # 2. 必要的配置文件
        cp PaddleOCR/deploy/cpp_infer/tools/config.txt release_package/config/ || true
        cp PaddleOCR/deploy/cpp_infer/tools/*.txt release_package/ || true
        
        # 3. Paddle Inference 依赖库 (.so 文件)
        # 注意: Linux 下必须要将这些 .so 也就是动态库一起发布，或者要求用户安装
        cp -L ${{ env.PADDLE_LIB_DIR }}/paddle/lib/*.so release_package/lib/
        # 如果有 iomp5 或 mkl 库也需要复制
        cp -L ${{ env.PADDLE_LIB_DIR }}/third_party/install/mklml/lib/*.so release_package/lib/ || true
        cp -L ${{ env.PADDLE_LIB_DIR }}/third_party/install/mkldnn/lib/*.so* release_package/lib/ || true
        
        # 4. OpenCV 依赖库 (如果不是系统安装，最好也带上，或者让用户自己装)
        cp -L ${{ github.workspace }}/opencv_install/lib/*.so* release_package/lib/
        
        # 创建启动脚本
        echo '#!/bin/bash' > release_package/run.sh
        echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(pwd)/lib' >> release_package/run.sh
        echo './ppocr "$@"' >> release_package/run.sh
        chmod +x release_package/run.sh
        
        echo "Packaging complete."

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: paddleocr-cpp-linux-build
        path: release_package/
        retention-days: 7

    - name: Zip artifacts for release
      if: github.event_name == 'workflow_dispatch'
      run: |
        cd release_package
        zip -r ../paddleocr-linux-${{ github.event.inputs.version }}.zip .

    - name: Create GitHub Release
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: PaddleOCR C++ Linux Build ${{ github.event.inputs.version }}
        body: |
          ## PaddleOCR C++ Linux (Ubuntu 20.04) Build
          
          Built following official v3.x documentation.
          
          ### Requirements
          - OS: Ubuntu 20.04 (Recommended) or System with OpenSSL 1.1 installed.
          - GLIBC: Compatible with GCC 8.2+
          
          ### How to run
          1. Extract the zip.
          2. Run `./run.sh system --image_dir=./your_images --det_model_dir=...`
          
          ### Info
          - **OpenCV**: 4.7.0 (with Freetype for Chinese rendering)
          - **Paddle Inference**: 3.2.2 (CPU/MKL)
        files: paddleocr-linux-${{ github.event.inputs.version }}.zip
