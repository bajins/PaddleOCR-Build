name: Build PaddleOCR C++ (Linux CPU with Static OpenCV & Prebuilt Paddle Inference)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
  pull_request:
    branches: [ main ]

# https://www.paddleocr.ai/main/version3.x/deployment/cpp/OCR.html
jobs:
  build:
    # https://docs.github.com/en/actions/concepts/runners/github-hosted-runners
    # https://github.com/actions/runner-images
    # åŽŸå› : Paddle Inference 2.6.1 ä¾èµ– OpenSSL 1.1ï¼Œè€Œ ubuntu-22.04 é»˜è®¤æ˜¯ OpenSSL 3.0ï¼Œä¼šå¯¼è‡´è¿è¡Œæ—¶å´©æºƒã€‚
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        # å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…·
        sudo apt-get install -y build-essential cmake git pkg-config yasm nasm wget unzip tree
        # OpenCV ä¾èµ– (ç”¨äºŽæºç ç¼–è¯‘)
        sudo apt-get install -y libgtk2.0-dev libavcodec-dev libavformat-dev
        sudo apt-get install -y libswscale-dev libjpeg-dev libpng-dev libtiff-dev
        # Freetype/Harfbuzz ä¾èµ– (ç”¨äºŽ OpenCV ç»˜åˆ¶ä¸­æ–‡)
        sudo apt-get install -y libfreetype6-dev libharfbuzz-dev libssl-dev
    # -----------------------------------------------------------------------
    # æž„å»º OpenCV (é™æ€åº“ + Freetype æ”¯æŒ)
    # -----------------------------------------------------------------------
    - name: Cache OpenCV Build
      id: cache-opencv
      uses: actions/cache@v3
      with:
        path: opencv_install
        key: ${{ runner.os }}-opencv-4.7.0-freetype-v2

    - name: Clone and Build OpenCV 4.7.0
      if: steps.cache-opencv.outputs.cache-hit != 'true'
      run: |
        OPENCV_VER="4.7.0"
        
        git clone https://github.com/opencv/opencv.git opencv_source -b ${OPENCV_VER} --depth 1
        # ä¸‹è½½ opencv_contrib ä»¥æ”¯æŒ freetype (è§£å†³ä¸­æ–‡ä¹±ç )
        git clone https://github.com/opencv/opencv_contrib.git opencv_contrib -b ${OPENCV_VER} --depth 1
        
        
        # ä¸‹è½½ Core å’Œ Contrib (Contrib åŒ…å« freetype æ¨¡å—)
        #wget -q https://github.com/opencv/opencv/archive/${OPENCV_VER}.zip -O opencv.zip
        #unzip -q opencv.zip && mv opencv-${OPENCV_VER} opencv_source
        
        #wget -q https://github.com/opencv/opencv_contrib/archive/${OPENCV_VER}.zip -O opencv_contrib.zip
        #unzip -q opencv_contrib.zip && mv opencv_contrib-${OPENCV_VER} opencv_contrib
        
        mkdir -p opencv_build
        cd opencv_build
        
        cmake ../opencv_source \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/opencv_install \
          -DOPENCV_EXTRA_MODULES_PATH=../opencv_contrib/modules \
          -DBUILD_SHARED_LIBS=ON \
          -DWITH_FREETYPE=ON \
          -DWITH_GTK=ON \
          -DWITH_QT=OFF \
          -DBUILD_TESTS=OFF \
          -DBUILD_PERF_TESTS=OFF \
          -DBUILD_EXAMPLES=OFF \
          -DBUILD_opencv_apps=OFF \
          -DBUILD_opencv_gapi=OFF
        
        make -j$(nproc)
        make install
        
        # æ¸…ç†ä»¥èŠ‚çœç©ºé—´
        cd .. && rm -rf opencv_source opencv_contrib opencv_build *.zip
    
    # -----------------------------------------------------------------------
    # é€‰é¡¹ A: ä¸‹è½½å®˜æ–¹é¢„ç¼–è¯‘ Paddle Inference åº“ (æŽ¨èï¼Œé€Ÿåº¦å¿«)
    # -----------------------------------------------------------------------
    - name: Download Paddle Inference Library (Linux CPU)
      run: |
        mkdir -p paddle_inference_lib
        cd paddle_inference_lib
        # ä¸‹è½½ Paddle Inference (GCC 8.2, CPU, MKL/OpenBLAS)
        # https://www.paddlepaddle.org.cn/inference/v3.0/guides/install/download_lib.html
        wget -q https://paddle-inference-lib.bj.bcebos.com/3.2.2/cxx_c/Linux/CPU/gcc8.2_avx_mkl/paddle_inference.tgz
        tar -xf paddle_inference.tgz
        # ç»“æž„é€šå¸¸æ˜¯: paddle_inference/paddle/lib
        echo "PADDLE_LIB_DIR=$(pwd)/paddle_inference" >> $GITHUB_ENV
        # éªŒè¯
        ls -R paddle_inference/paddle/lib
    
    # -----------------------------------------------------------------------
    # é€‰é¡¹ B: ä»Žæºç ç¼–è¯‘ Paddle Inference (å¦‚æžœä¸ä½¿ç”¨é¢„ç¼–è¯‘åº“ï¼Œå–æ¶ˆä¸‹æ–¹æ³¨é‡Š)
    # æ³¨æ„: åœ¨ GitHub Actions å…è´¹ runner ä¸Šæžæ˜“è¶…æ—¶æˆ–å†…å­˜æº¢å‡º
    # https://www.paddlepaddle.org.cn/inference/v3.0/guides/install/compile/source_compile_under_Linux.html
    # -----------------------------------------------------------------------
    # - name: Clone Paddle Source
    #   run: |
    #     git clone https://github.com/PaddlePaddle/Paddle.git paddle_source
    #     cd paddle_source
    #     git checkout release/3.3
    #
    # - name: Build Paddle Inference from Source
    #   working-directory: paddle_source
    #   run: |
    #     mkdir build && cd build
    #     cmake .. \
    #       -DWITH_GPU=OFF \
    #       -DWITH_MKL=ON \
    #       -DWITH_TENSORRT=OFF \
    #       -DON_INFER=ON \
    #       -DWITH_PYTHON=OFF \
    #       -DCMAKE_BUILD_TYPE=Release
    #     make -j$(nproc)
    #     make inference_lib_dist
    #     echo "PADDLE_LIB_DIR=$(pwd)/paddle_inference" >> $GITHUB_ENV


    # -----------------------------------------------------------------------
    # ç¼–è¯‘ PaddleOCR C++ Demo
    # å‚è€ƒæ–‡æ¡£: https://www.paddleocr.ai/main/version3.x/deployment/cpp/OCR.html#step-2
    # -----------------------------------------------------------------------
    - name: Clone PaddleOCR
      #uses: actions/checkout@v4
      #with:
      #  repository: PaddlePaddle/PaddleOCR
      #  ref: v3.3.2
      #  path: PaddleOCR
      run: |
        git clone https://github.com/PaddlePaddle/PaddleOCR.git
        cd PaddleOCR
        git checkout release/3.3
        
    - name: Configure and Build PaddleOCR C++ Demo
      run: |
        cd PaddleOCR/deploy/cpp_infer
        
        # å¦‚æžœä½¿ç”¨çš„æ˜¯é¢„ç¼–è¯‘åº“ï¼Œåº“ç»“æž„å¯èƒ½ç•¥æœ‰ä¸åŒ
        # é¢„ç¼–è¯‘åº“è·¯å¾„: $PADDLE_LIB_DIR/paddle/lib/libpaddle_inference.so
        # OpenCV è·¯å¾„: ${{ github.workspace }}/opencv_install
        tree -d ${{ env.PADDLE_LIB_DIR }}
        tree -d ${{ github.workspace }}/opencv_install
        echo "Listing OpenCV install directory:"
        ls -R ${{ github.workspace }}/opencv_install | grep "OpenCVConfig.cmake" || echo "Config file not found!"
        
        mkdir -p build
        cd build
        
        # PADDLE_LIB: æŒ‡å‘ paddle_inference æ–‡ä»¶å¤¹æ ¹ç›®å½•
        # OPENCV_DIR: æŒ‡å‘åŒ…å« OpenCVConfig.cmake çš„æ–‡ä»¶å¤¹
        # WITH_MKL=ON: å¿…é¡»å¼€å¯ï¼Œå› ä¸ºä¸‹è½½çš„ inference lib æ˜¯ MKL ç‰ˆ
        cmake .. \
          -DPADDLE_LIB=${{ env.PADDLE_LIB_DIR }} \
          -DOPENCV_DIR=${{ github.workspace }}/opencv_install/lib/cmake/opencv4 \
          -DWITH_MKL=ON \
          -DWITH_GPU=OFF \
          -DWITH_STATIC_LIB=OFF \
          -DWITH_TENSORRT=OFF \
          -DCMAKE_BUILD_TYPE=Release
        
        make -j$(nproc)
        
        # éªŒè¯ç”Ÿæˆ
        ls -lh ppocr
        ./ppocr --help || echo "Help menu check"
    
    # -----------------------------------------------------------------------
    # æ‰“åŒ…å‘å¸ƒ
    # -----------------------------------------------------------------------
    - name: Prepare Artifacts
      run: |
        PKG_NAME="paddleocr-linux-cpu-cpp"
        mkdir -p $PKG_NAME/lib
        mkdir -p $PKG_NAME/config
        
        BASE_DIR=$PKG_NAME
        
        # 1. å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        cp PaddleOCR/deploy/cpp_infer/build/ppocr $BASE_DIR/
        
        # 2. å¤åˆ¶é…ç½®å’Œèµ„æºæ–‡ä»¶
        cp PaddleOCR/deploy/cpp_infer/tools/config.txt $BASE_DIR/config/ || true
        cp PaddleOCR/deploy/cpp_infer/tools/*.txt $BASE_DIR/ || true
        # 3.x ç‰ˆæœ¬é€šå¸¸éœ€è¦ tools ä¸‹çš„ä¸€äº›è¾…åŠ©æ–‡ä»¶
        
        # 3. å¤åˆ¶ Paddle ä¾èµ–åº“ (.so)
        # Paddle æ ¸å¿ƒåº“
        cp -L ${{ env.PADDLE_LIB_DIR }}/paddle/lib/*.so* $BASE_DIR/lib/
        # ç¬¬ä¸‰æ–¹åº“ (MKL, MKLDNN, IOMP5 ç­‰)
        # Paddle ç»“æž„ä¸­ third_party é€šå¸¸åŒ…å«è¿™äº›
        THIRD_PARTY="${{ env.PADDLE_LIB_DIR }}/third_party/install"
        [ -d "$THIRD_PARTY/mklml/lib" ] && cp -L $THIRD_PARTY/mklml/lib/*.so* $BASE_DIR/lib/
        [ -d "$THIRD_PARTY/mkldnn/lib" ] && cp -L $THIRD_PARTY/mkldnn/lib/*.so* $BASE_DIR/lib/
        # æœ‰æ—¶å€™ iomp5 åœ¨ mklml é‡Œï¼Œæœ‰æ—¶å•ç‹¬
        find $THIRD_PARTY -name "libiomp5.so" -exec cp {} $BASE_DIR/lib/ \;
        
        # 4. å¤åˆ¶ OpenCV åº“
        cp -L ${{ github.workspace }}/opencv_install/lib/*.so* $BASE_DIR/lib/
        
        # 5. åˆ›å»ºå¯åŠ¨è„šæœ¬ run.sh (è‡ªåŠ¨è®¾ç½® LD_LIBRARY_PATH)
        echo '#!/bin/bash' > $BASE_DIR/run.sh
        echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(dirname "$(readlink -f "$0")")/lib' >> $BASE_DIR/run.sh
        echo './ppocr "$@"' >> $BASE_DIR/run.sh
        chmod +x $BASE_DIR/run.sh
        
        echo "Artifacts packed in $BASE_DIR"
    
  #  - name: Upload build artifacts
  #    uses: actions/upload-artifact@v4
  #    with:
  #      name: paddleocr-cpp-linux-build
  #      path: release_package/
  #      retention-days: 7
  #  
  #release:
  #  needs: build
  #  if: github.event_name == 'workflow_dispatch'
  #  runs-on: ubuntu-latest
  #  permissions:
  #    contents: write
  #  steps:
  #  - name: Download build artifacts
  #    uses: actions/download-artifact@v4
  #    with:
  #      path: release_package/
  #      pattern: paddleocr-cpp-linux-build

    - name: Zip artifacts for release
      if: github.event_name == 'workflow_dispatch'
      run: |
        cd release_package
        zip -r ../paddleocr-linux-${{ github.event.inputs.version }}.zip . --exclude "*.git*"
    
    - name: Create GitHub Release
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: PaddleOCR C++ Linux Build ${{ github.event.inputs.version }}
        body: |
          ## PaddleOCR C++ Linux (Ubuntu 20.04) Build
          
          Built following official v3.x documentation.
          
          ### Requirements
          - **PaddleOCR Version**: [v3.3.2](https://github.com/PaddlePaddle/PaddleOCR/releases/tag/v3.3.2)
          - **Paddle Inference**: 3.2.2 (GCC 8.2 / AVX / MKL)
          - **OpenCV**: 4.7.0 (Compiled with Freetype & GTK)
          - **OS**: Ubuntu 20.04
          
          ### ðŸš€ How to Run
          
          1. Download and unzip `paddleocr-linux-${{ github.event.inputs.version }}.zip`.
          2. Use the `run.sh` script (no need to install libraries manually):
          
          ```bash
          # Basic usage
          ./run.sh system --image_dir=./path/to/image --det_model_dir=...
          
          # View help
          ./run.sh --help
          ```
        files: paddleocr-linux-${{ github.event.inputs.version }}.zip
