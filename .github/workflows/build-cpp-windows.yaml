name: Build PaddleOCR C++ (Windows CPU with Static OpenCV 4.7.0)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSBuild (Visual Studio 2022)
      uses: microsoft/setup-msbuild@v2

    - name: Install CMake
      uses: lukka/get-cmake@latest
      with:
        version: latest

    - name: Manual Install vcpkg with static dependencies (full chain for harfbuzz)
      shell: powershell
      run: |
        $vcpkgTemp = "${{ runner.temp }}/vcpkg"
        if (Test-Path $vcpkgTemp) { Remove-Item $vcpkgTemp -Recurse -Force }
        git clone https://github.com/Microsoft/vcpkg.git $vcpkgTemp
        cd $vcpkgTemp
        .\bootstrap-vcpkg.bat
        $env:VCPKG_DEFAULT_TRIPLET = "x64-windows-static"
        # 安装全依赖链 (harfbuzz 需要 icu/graphite2/zlib/png/bzip2 等)
        .\vcpkg.exe install freetype harfbuzz icu graphite2 zlib libpng bzip2 --triplet x64-windows-static --head --verbose --clean-after-build
        .\vcpkg.exe integrate install
        Write-Output "vcpkg install complete. Toolchain: $vcpkgTemp\scripts\buildsystems\vcpkg.cmake"
        # 验证
        .\vcpkg.exe list | Select-String "freetype|harfbuzz|icu|graphite2"

    - name: Clone PaddleOCR source
      run: git clone https://github.com/PaddlePaddle/PaddleOCR.git

    - name: Download Paddle Inference (Windows CPU v3.0.0)
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://paddle-inference-lib.bj.bcebos.com/3.0.0/cxx_c/Windows/CPU/x86-64_avx-mkl-vs2019/paddle_inference.zip" -OutFile "paddle_inference.zip" -UseBasicParsing
        Expand-Archive -Path "paddle_inference.zip" -DestinationPath "C:\paddle_inference"

    - name: Download dirent.h and copy to VS include
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://paddleocr.bj.bcebos.com/deploy/cpp_infer/cpp_files/dirent.h" -OutFile "dirent.h" -UseBasicParsing
        $vsInclude = "${env:VSINSTALLDIR}Auxiliary\VS\include"
        Copy-Item "dirent.h" -Destination $vsInclude -Force
        Write-Output "Copied dirent.h to $vsInclude"

    - name: Clone and build OpenCV 4.7.0 from source (static with freetype)
      shell: powershell
      run: |
        $vcpkgTemp = "${{ runner.temp }}/vcpkg"
        $vcpkgToolchain = "$vcpkgTemp\scripts\buildsystems\vcpkg.cmake"
        $freetypeInclude = "$vcpkgTemp\installed\x64-windows-static\include"
        $freetypeLib = "$vcpkgTemp\installed\x64-windows-static\lib\freetype.lib"
        git clone https://github.com/opencv/opencv.git C:\opencv_source -b 4.7.0
        mkdir C:\opencv_build
        cd C:\opencv_build
        cmake C:\opencv_source `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DCMAKE_TOOLCHAIN_FILE=$vcpkgToolchain `
          -DBUILD_SHARED_LIBS=OFF `
          -DWITH_FREETYPE=ON `
          -DFREETYPE_INCLUDE_DIRS=$freetypeInclude `
          -DFREETYPE_LIBRARY=$freetypeLib `
          -DBUILD_opencv_world=ON `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_INSTALL_PREFIX="C:\opencv_install"
        msbuild /p:Configuration=Release /p:Platform=x64 /m /maxcpucount:4 INSTALL.vcxproj
        Write-Output "OpenCV static build completed. Install dir: C:\opencv_install"
        # 检查 freetype 支持 (fallback 手动路径防检测失败)
        Select-String -Path CMakeCache.txt -Pattern "FREETYPE" | Write-Output

    - name: Configure and build PaddleOCR C++ demo
      shell: powershell
      run: |
        $vcpkgTemp = "${{ runner.temp }}/vcpkg"
        $vcpkgToolchain = "$vcpkgTemp\scripts\buildsystems\vcpkg.cmake"
        cd PaddleOCR\deploy\cpp_infer
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_TOOLCHAIN_FILE=$vcpkgToolchain `
          -DOPENCV_DIR="C:\opencv_install" `
          -DOpenCV_DIR="C:\opencv_install" `
          -DPADDLE_LIB="C:\paddle_inference\paddle\lib"
        msbuild ppocr.sln /p:Configuration=Release /p:Platform=x64 /m

    - name: Copy runtime files to Release folder
      shell: powershell
      run: |
        $releaseDir = "PaddleOCR\deploy\cpp_infer\build\Release"
        if (!(Test-Path $releaseDir)) { mkdir $releaseDir }
        Copy-Item "C:\paddle_inference\paddle\lib\paddle_inference.dll" -Destination $releaseDir -Force
        Copy-Item "C:\paddle_inference\paddle\lib\common.dll" -Destination $releaseDir -Force
        Write-Output "Files prepared in $releaseDir"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: paddleocr-cpp-windows-static-build
        path: |
          PaddleOCR/deploy/cpp_infer/build/Release/
          C:\opencv_install/
          PaddleOCR/deploy/cpp_infer/paddle_inference/
        retention-days: 7

  release:
    needs: build
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
        pattern: paddleocr-cpp-windows-static-build

    - name: Zip artifacts for release
      run: |
        cd artifacts
        find . -type f -name "*.dll" -o -name "*.exe" -o -name "*.lib" -o -name "*.h" | xargs zip -r ../paddleocr-build-${{ github.event.inputs.version }}.zip

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: PaddleOCR C++ Build ${{ github.event.inputs.version }}
        body: |
          ## PaddleOCR C++ Windows CPU Build
          
          - **OpenCV**: 4.7.0 (static, with freetype/harfbuzz)
          - **Paddle Inference**: v3.0.0 CPU
          - **Artifacts**: ppocr.exe, DLLs, libs, headers
          
          Download `paddleocr-build-${{ github.event.inputs.version }}.zip` for deployment.
        files: paddleocr-build-${{ github.event.inputs.version }}.zip
        generate_release_notes: false
