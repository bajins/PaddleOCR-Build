name: Build PaddleOCR C++ (Windows CPU with Static OpenCV & Source Paddle Inference)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSBuild (Visual Studio 2022)
      uses: microsoft/setup-msbuild@v2

    - name: Install CMake
      uses: lukka/get-cmake@latest
      with:
        version: latest

    - name: Setup VS Developer Environment
      shell: powershell
      run: |
        & "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        Write-Output "VS Developer env ready"

    - name: Install Python 3.10 and deps
      shell: powershell
      run: |
        # 安装 Python 3.10 (兼容指南)
        choco install python --version=3.10.0 -y
        $env:PATH = "C:\Python310;C:\Python310\Scripts;$env:PATH"
        python --version
        pip install numpy protobuf wheel ninja

    #- name: Setup vcpkg
    #  uses: lukka/run-vcpkg@v11
    #  with:
    #    # 指定 vcpkg 的某个特定 commit hash，该 commit 对应的 ports 目录里 freetype 版本是 2.13.2
    #    vcpkgGitCommitId: '这里填写包含 freetype 2.13.2 的 commit hash'
    - name: Manual Install vcpkg with static dependencies (full chain for harfbuzz)
      shell: powershell
      run: |
        $vcpkgTemp = "${{ runner.temp }}/vcpkg"
        if (Test-Path $vcpkgTemp) { Remove-Item $vcpkgTemp -Recurse -Force }
        git clone https://github.com/Microsoft/vcpkg.git $vcpkgTemp
        cd $vcpkgTemp
        .\bootstrap-vcpkg.bat
        $env:VCPKG_DEFAULT_TRIPLET = "x64-windows-static"
        $env:VCPKG_DEBUG = "1"  # 启用 debug 日志
        # 更新 ports 以修复 freetype URL bug
        .\vcpkg.exe update
        # 安装全依赖链 (锁定 freetype 稳定版，避免 --head 404)
        .\vcpkg.exe install freetype harfbuzz icu graphite2 zlib libpng bzip2 --triplet x64-windows-static --clean-after-build
        if ($LASTEXITCODE -ne 0) { exit 1 }
        .\vcpkg.exe integrate install
        Write-Output "vcpkg install complete. Toolchain: $vcpkgTemp\scripts\buildsystems\vcpkg.cmake"
        # 验证
        .\vcpkg.exe list | Select-String "freetype|harfbuzz|icu|graphite2"

    - name: Clone PaddleOCR source (release/3.2)
      run: |
        git clone https://github.com/PaddlePaddle/PaddleOCR.git
        cd PaddleOCR
        git checkout release/3.2
        if ($LASTEXITCODE -ne 0) { exit 1 }

    - name: Build Paddle Inference from source (3.2.0 CPU)
      shell: powershell
      run: |
        $vcpkgTemp = "${{ runner.temp }}/vcpkg"
        $vcpkgToolchain = "$vcpkgTemp\scripts\buildsystems\vcpkg.cmake"
        mkdir C:\paddle_source
        cd C:\paddle_source
        git clone https://github.com/PaddlePaddle/Paddle.git .
        git checkout release/3.2
        if ($LASTEXITCODE -ne 0) { exit 1 }
        mkdir build
        cd build
        cmake .. -GNinja `
          -DCMAKE_TOOLCHAIN_FILE="$vcpkgToolchain" `
          -DPYTHON_EXECUTABLE="C:\Python310\python.exe" `
          -DWITH_GPU=OFF `
          -DWITH_ONEDNN=ON `
          -DCMAKE_BUILD_TYPE=Release `
          -DWITH_UNITY_BUILD=ON `
          -DWITH_TESTING=OFF `
          -DWITH_PYTHON=OFF `
          -DON_INFER=ON
        if ($LASTEXITCODE -ne 0) { exit 1 }
        ninja -j4
        ninja install
        if ($LASTEXITCODE -ne 0) { exit 1 }
        Write-Output "Paddle Inference built. Lib dir: C:\paddle_source\build\paddle_inference_install_dir\paddle\lib"
        # 验证
        Get-ChildItem "C:\paddle_source\build\paddle_inference_install_dir\paddle\lib\*.dll"

    - name: Download dirent.h and copy to VS include
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://paddleocr.bj.bcebos.com/deploy/cpp_infer/cpp_files/dirent.h" -OutFile "dirent.h" -UseBasicParsing
        # 硬编码 VS 路径
        $vsInstallDir = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise"
        $vsInclude = "$vsInstallDir\VC\Auxiliary\VS\include"
        if (!(Test-Path $vsInclude)) { 
          New-Item -ItemType Directory -Path $vsInclude -Force | Out-Null
          Write-Output "Created VS include dir: $vsInclude"
        }
        Copy-Item "dirent.h" -Destination $vsInclude -Force
        Write-Output "Copied dirent.h to $vsInclude"
        # Fallback
        $localInclude = "PaddleOCR\deploy\cpp_infer\include"
        if (!(Test-Path $localInclude)) { mkdir $localInclude -Force }
        Copy-Item "dirent.h" -Destination $localInclude -Force
        Write-Output "Fallback: Copied to local $localInclude"

    - name: Clone and build OpenCV 4.7.0 from source (static with freetype)
      shell: powershell
      run: |
        $vcpkgTemp = "${{ runner.temp }}/vcpkg"
        $vcpkgToolchain = "$vcpkgTemp\scripts\buildsystems\vcpkg.cmake"
        $freetypeInclude = "$vcpkgTemp\installed\x64-windows-static\include"
        $freetypeLib = "$vcpkgTemp\installed\x64-windows-static\lib\freetype.lib"
        git clone https://github.com/opencv/opencv.git C:\opencv_source -b 4.7.0
        mkdir C:\opencv_build
        cd C:\opencv_build
        cmake C:\opencv_source `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DCMAKE_TOOLCHAIN_FILE="$vcpkgToolchain" `
          -DBUILD_SHARED_LIBS=OFF `
          -DWITH_FREETYPE=ON `
          -DFREETYPE_INCLUDE_DIRS="$freetypeInclude" `
          -DFREETYPE_LIBRARY="$freetypeLib" `
          -DBUILD_opencv_world=ON `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_INSTALL_PREFIX="C:\opencv_install"
        if ($LASTEXITCODE -ne 0) { exit 1 }
        msbuild /p:Configuration=Release /p:Platform=x64 /m /maxcpucount:4 INSTALL.vcxproj
        Write-Output "OpenCV static build completed. Install dir: C:\opencv_install"
        Select-String -Path CMakeCache.txt -Pattern "FREETYPE" | Write-Output

    - name: Configure and build PaddleOCR C++ demo
      shell: powershell
      run: |
        $vcpkgTemp = "${{ runner.temp }}/vcpkg"
        $vcpkgToolchain = "$vcpkgTemp\scripts\buildsystems\vcpkg.cmake"
        $paddleLib = "C:\paddle_source\build\paddle_inference_install_dir\paddle\lib"
        cd PaddleOCR\deploy\cpp_infer
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_TOOLCHAIN_FILE="$vcpkgToolchain" `
          -DOPENCV_DIR="C:\opencv_install" `
          -DOpenCV_DIR="C:\opencv_install" `
          -DPADDLE_LIB="$paddleLib" `
          -I "PaddleOCR\deploy\cpp_infer\include"
        if ($LASTEXITCODE -ne 0) { exit 1 }
        msbuild ppocr.sln /p:Configuration=Release /p:Platform=x64 /m

    - name: Copy runtime files to Release folder
      shell: powershell
      run: |
        $releaseDir = "PaddleOCR\deploy\cpp_infer\build\Release"
        if (!(Test-Path $releaseDir)) { mkdir $releaseDir }
        $paddleLib = "C:\paddle_source\build\paddle_inference_install_dir\paddle\lib"
        Copy-Item "$paddleLib\paddle_inference.dll" -Destination $releaseDir -Force
        Copy-Item "$paddleLib\common.dll" -Destination $releaseDir -Force
        Write-Output "Files prepared in $releaseDir"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: paddleocr-cpp-windows-static-build
        path: |
          PaddleOCR/deploy/cpp_infer/build/Release/
          C:\opencv_install/
          C:\paddle_source/build/paddle_inference_install_dir/
        retention-days: 7

  release:
    needs: build
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
        pattern: paddleocr-cpp-windows-static-build

    - name: Zip artifacts for release
      run: |
        cd artifacts
        zip -r ../paddleocr-build-${{ github.event.inputs.version }}.zip . --exclude "*.git*"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: PaddleOCR C++ Build ${{ github.event.inputs.version }} (Source Paddle Inference 3.2.0)
        body: |
          ## PaddleOCR C++ Windows CPU Build (Source Paddle Inference 3.2.0, PaddleOCR release/3.2)
          
          - **OpenCV**: 4.7.0 (static, with freetype/harfbuzz)
          - **Paddle Inference**: 3.2.0 (source-built, CPU/OneDNN)
          - **PaddleOCR**: release/3.2
          - **Artifacts**: ppocr.exe, DLLs, libs, headers
          
          Download `paddleocr-build-${{ github.event.inputs.version }}.zip` for deployment.
        files: paddleocr-build-${{ github.event.inputs.version }}.zip
        generate_release_notes: false
