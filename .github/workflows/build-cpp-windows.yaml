name: Build PaddleOCR C++ (Windows CPU)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
  pull_request:
    branches: [ main ]

# https://www.paddleocr.ai/main/version3.x/deployment/cpp/OCR_windows.html
jobs:
  build:
    # https://docs.github.com/en/actions/concepts/runners/github-hosted-runners
    # https://github.com/actions/runner-images
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    # 使用 ilammy/msvc-dev-cmd 自动配置并持久化 VS 环境变量
    # 这解决了 UINT64_MAX 找不到的问题，因为后续步骤能正确找到 cl.exe 和头文件
    - name: Setup MSVC Developer Command Prompt
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Setup MSBuild (Visual Studio 2022)
      uses: microsoft/setup-msbuild@v2

    - name: Install CMake
      uses: lukka/get-cmake@latest
      with:
        version: 3.29

    - name: Setup VS Developer Environment
      shell: powershell
      run: |
        & "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        Write-Output "VS Developer env ready"
    
    - name: Install Python 3.10 and deps
      shell: powershell
      run: |
        # 安装 Python 3.10
        choco install python --version=3.10.0 -y
        $env:PATH = "C:\Python310;C:\Python310\Scripts;$env:PATH"
        python --version
        pip install numpy protobuf wheel ninja
    
    #- name: Setup vcpkg
    #  uses: lukka/run-vcpkg@v11
    #  with:
    #    # 指定 vcpkg 的某个特定 commit hash，该 commit 对应的 ports 目录里 freetype 版本是 2.13.2
    #    vcpkgGitCommitId: '这里填写包含 freetype 2.13.2 的 commit hash'
    
    - name: Manual Install vcpkg with static dependencies (full chain for harfbuzz)
      shell: powershell
      run: |
        $vcpkgTemp = "${{ runner.temp }}/vcpkg"
        if (Test-Path $vcpkgTemp) { Remove-Item $vcpkgTemp -Recurse -Force }
        
        git clone https://github.com/Microsoft/vcpkg.git $vcpkgTemp --single-branch --depth 1
        
        cd $vcpkgTemp
        
        .\bootstrap-vcpkg.bat
        
        $env:VCPKG_DEFAULT_TRIPLET = "x64-windows-static"
        $env:VCPKG_DEBUG = "1"  # 启用 debug 日志
        
        # 更新 ports 以修复 freetype URL bug
        .\vcpkg.exe update
        
        # 安装全依赖链
        .\vcpkg.exe install freetype harfbuzz icu graphite2 zlib libpng bzip2 --triplet x64-windows-static --clean-after-build
        if ($LASTEXITCODE -ne 0) { exit 1 }
        
        .\vcpkg.exe integrate install
        
        Write-Output "vcpkg install complete. Toolchain: $vcpkgTemp\scripts\buildsystems\vcpkg.cmake"
        # 验证
        .\vcpkg.exe list | Select-String "freetype|harfbuzz|icu|graphite2"
    
    - name: Download dirent.h and copy to VS include
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://paddleocr.bj.bcebos.com/deploy/cpp_infer/cpp_files/dirent.h" -OutFile "dirent.h" -UseBasicParsing
        # 硬编码 VS 路径
        $vsInstallDir = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise"      
        $vsInclude = "$vsInstallDir\VC\Auxiliary\VS\include"
        # 使用环境变量获取 VS 路径，比硬编码更安全
        #$vsInclude = "$env:VCINSTALLDIR\Auxiliary\VS\include"  
        if (!(Test-Path $vsInclude)) { 
          New-Item -ItemType Directory -Path $vsInclude -Force | Out-Null
          Write-Output "Created VS include dir: $vsInclude"
        }
        Copy-Item "dirent.h" -Destination $vsInclude -Force
        Write-Output "Copied dirent.h to $vsInclude"
    
    #- name: Download and Setup OpenCV 4.7.0 Pre-built
    #  shell: powershell
    #  run: |
    #    # 1. 下载官方预编译包
    #    $url = "https://github.com/opencv/opencv/releases/download/4.7.0/opencv-4.7.0-windows.exe"
    #    $outFile = "opencv-4.7.0-windows.exe"
    #    Write-Output "Downloading OpenCV 4.7.0..."
    #    Invoke-WebRequest -Uri $url -OutFile $outFile -UseBasicParsing
    #
    #    # 2. 使用 7z 解压 (比运行 exe 更稳健，不会弹出 GUI)
    #    # -o"." 表示解压到当前目录，解压后会自动生成 opencv 文件夹
    #    Write-Output "Extracting..."
    #    7z x $outFile -o"." -y
    #
    #    # 3. 验证目录结构
    #    $opencvDir = Resolve-Path "opencv"
    #    $buildDir = "$opencvDir\build"
    #    if (Test-Path "$buildDir\x64\vc16\lib") {
    #        Write-Output "OpenCV extracted successfully to: $opencvDir"
    #    } else {
    #        Write-Error "OpenCV extraction failed or folder structure mismatch!"
    #        exit 1
    #    }
    #
    #    # 4. 设置环境变量供后续 CMake 使用
    #    # 注意：VS2022 兼容 VS2019 的二进制文件 (vc16)
    #    echo "OpenCV_DIR=$buildDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
    #    echo "OPENCV_DIR=$buildDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
    
    - name: Clone and build OpenCV 4.7.0 from source
      shell: powershell
      run: |
        $vcpkgTemp = "${{ runner.temp }}/vcpkg"
        $vcpkgToolchain = "$vcpkgTemp\scripts\buildsystems\vcpkg.cmake"
        $freetypeInclude = "$vcpkgTemp\installed\x64-windows-static\include"
        $freetypeLib = "$vcpkgTemp\installed\x64-windows-static\lib\freetype.lib"
        
        $OPENCV_VER="4.7.0"
        
        git clone https://github.com/opencv/opencv.git C:\opencv_source -b $OPENCV_VER --depth 1
        # 下载 opencv_contrib 以支持 freetype (解决中文乱码)
        git clone https://github.com/opencv/opencv_contrib.git C:\opencv_contrib -b $OPENCV_VER --depth 1
        
        mkdir C:\opencv_build
        cd C:\opencv_build
        
        cmake C:\opencv_source `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DCMAKE_TOOLCHAIN_FILE="$vcpkgToolchain" `
          -DBUILD_SHARED_LIBS=OFF `
          -DFREETYPE_INCLUDE_DIRS="$freetypeInclude" `
          -DFREETYPE_LIBRARY="$freetypeLib" `
          -DBUILD_opencv_world=ON `
          -DCMAKE_INSTALL_PREFIX="C:\opencv_install" `
          -DOPENCV_EXTRA_MODULES_PATH="C:\opencv_contrib\modules" `
          -DBUILD_opencv_freetype=ON `
          -DWITH_FREETYPE=ON `
          -DBUILD_TESTS=OFF `
          -DBUILD_PERF_TESTS=OFF `
          -DBUILD_EXAMPLES=OFF `
          -DBUILD_opencv_apps=OFF `
          -DBUILD_opencv_gapi=OFF `
          -DWITH_IPP=OFF `
          -DBUILD_IPP_IW=OFF `
          -DWITH_LAPACK=OFF `
          -DWITH_EIGEN=OFF `
          -DCMAKE_INSTALL_LIBDIR=lib64 `
          -DWITH_ZLIB=ON `
          -DBUILD_ZLIB=ON `
          -DWITH_JPEG=ON `
          -DBUILD_JPEG=ON `
          -DWITH_PNG=ON `
          -DBUILD_PNG=ON `
          -DWITH_TIFF=ON `
          -DBUILD_TIFF=ON `
          -DCMAKE_BUILD_TYPE=Release
        
        if ($LASTEXITCODE -ne 0) { exit 1 }
        
        msbuild /p:Configuration=Release /p:Platform=x64 /m /maxcpucount:4 INSTALL.vcxproj
        Write-Output "OpenCV static build completed. Install dir: C:\opencv_install"
        Select-String -Path CMakeCache.txt -Pattern "FREETYPE" | Write-Output
    
    # -----------------------------------------------------------------------
    # 选项 A: 下载官方预编译 Paddle Inference 库 (推荐，速度快)
    # -----------------------------------------------------------------------
    - name: Download Paddle Inference Library (Windows CPU)
      shell: powershell
      run: |
        # 1. 创建目录
        $workDir = "paddle_inference_lib"
        if (Test-Path $workDir) { Remove-Item $workDir -Recurse -Force }
        New-Item -ItemType Directory -Path $workDir -Force | Out-Null
        cd $workDir

        # 2. 下载 Paddle Inference (Windows CPU, MKL, VS2019)
        # https://www.paddlepaddle.org.cn/inference/v3.0/guides/install/download_lib.html#windows
        # 注意：VS2019 编译的库通常兼容 VS2022
        $url = "https://paddle-inference-lib.bj.bcebos.com/3.2.2/cxx_c/Windows/CPU/x86-64_avx-mkl-vs2019/paddle_inference.zip"
        $zipName = "paddle_inference.zip"
        
        Write-Output "Downloading from $url..."
        Invoke-WebRequest -Uri $url -OutFile $zipName -UseBasicParsing

        # 3. 解压 Zip 文件
        Write-Output "Extracting $zipName..."
        Expand-Archive -Path $zipName -DestinationPath paddle_inference -Force

        # 4. 设置环境变量 PADDLE_LIB_DIR
        # 解压后通常目录结构为: paddle_inference/paddle/lib
        $extractRoot = Resolve-Path "paddle_inference"
        $fullPath = $extractRoot.Path
        
        # 将路径写入 GITHUB_ENV 供后续步骤使用
        echo "PADDLE_LIB_DIR=$fullPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        
        # 5. 验证文件存在
        Write-Output "Paddle Inference installed to: $fullPath"
        if (Test-Path "$fullPath\paddle\lib\paddle_inference.lib") {
            Write-Output "Verification Success: paddle_inference.lib found."
            Get-ChildItem "$fullPath\paddle\lib"
        } else {
            Write-Error "Verification Failed: paddle_inference.lib not found!"
            exit 1
        }
    
    # -----------------------------------------------------------------------
    # 选项 B: 从源码编译 Paddle Inference (如果不使用预编译库，取消下方注释)
    # 注意: 在 GitHub Actions 免费 runner 上极易超时或内存溢出
    # https://www.paddlepaddle.org.cn/inference/v3.0/guides/install/compile/source_compile_under_Windows.html
    # -----------------------------------------------------------------------
    #- name: Build Paddle Inference from source
    #  shell: powershell
    #  run: |
    #    $vcpkgTemp = "${{ runner.temp }}/vcpkg"
    #    $vcpkgToolchain = "$vcpkgTemp\scripts\buildsystems\vcpkg.cmake"
    #    
    #    mkdir C:\paddle_source
    #    cd C:\paddle_source
    #    
    #    git clone https://github.com/PaddlePaddle/Paddle.git . -b release/3.3 --depth 1
    #    
    #    if ($LASTEXITCODE -ne 0) { exit 1 }
    #    
    #    mkdir build
    #    cd build
    #    
    #    # -DCMAKE_SYSTEM_VERSION=10.0.20348.0 显式指定 SDK 版本有助于避免找不到头文件
    #    cmake .. -GNinja `
    #      -DCMAKE_TOOLCHAIN_FILE="$vcpkgToolchain" `
    #      -DPYTHON_EXECUTABLE="C:\Python310\python.exe" `
    #      -DWITH_GPU=OFF `
    #      -DWITH_ONEDNN=ON `
    #      -DCMAKE_BUILD_TYPE=Release `
    #      -DWITH_UNITY_BUILD=ON `
    #      -DWITH_TESTING=OFF `
    #      -DWITH_PYTHON=OFF `
    #      -DWITH_MKL=ON `
    #      -DON_INFER=ON `
    #      -DWITH_XBYAK=ON
    #    
    #    if ($LASTEXITCODE -ne 0) { exit 1 }
    #    
    #    ninja -j4
    #    ninja install
    #    if ($LASTEXITCODE -ne 0) { exit 1 }
    #
    #    $extractRoot = Resolve-Path "paddle_inference_install_dir"
    #    $fullPath = $extractRoot.Path
    #    # 将路径写入 GITHUB_ENV 供后续步骤使用
    #    echo "PADDLE_LIB_DIR=$fullPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
    #    
    #    Write-Output "Paddle Inference built. Lib dir: $fullPath\paddle\lib"
    #    # 验证
    #    Get-ChildItem "$fullPath\paddle\lib\*.dll"
    
    - name: Clone PaddleOCR source
      run: |
        git clone https://github.com/PaddlePaddle/PaddleOCR.git -b release/3.3 --depth 1
        if ($LASTEXITCODE -ne 0) { exit 1 }
    
    - name: Configure and build PaddleOCR C++ demo
      shell: powershell
      run: |
        $vcpkgTemp = "${{ runner.temp }}/vcpkg"
        $vcpkgToolchain = "$vcpkgTemp\scripts\buildsystems\vcpkg.cmake"
        $paddleLib = "${{ env.PADDLE_LIB_DIR }}\paddle\lib"
        
        cd PaddleOCR\deploy\cpp_infer
        
        tree ${{ env.PADDLE_LIB_DIR }}
        tree C:\opencv_install
        
        mkdir build
        cd build
        
        cmake .. -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_TOOLCHAIN_FILE="$vcpkgToolchain" `
          -DOPENCV_DIR="C:\opencv_install" `
          -DOpenCV_DIR="C:\opencv_install" `
          -DPADDLE_LIB="$paddleLib" `
        #  -DUSE_FREETYPE=ON `
          -I "PaddleOCR\deploy\cpp_infer\include"
        
        if ($LASTEXITCODE -ne 0) { exit 1 }
        
        msbuild ppocr.sln /p:Configuration=Release /p:Platform=x64 /m
    
    - name: Copy runtime files to Release folder
      shell: powershell
      run: |
        $releaseDir = "PaddleOCR\deploy\cpp_infer\build\Release"
        if (!(Test-Path $releaseDir)) { mkdir $releaseDir }
        
        $paddleLib = "${{ env.PADDLE_LIB_DIR }}\paddle\lib"
        
        # 静态编译下可能不需要 dll，但 paddle_inference 即使 ON_INFER=ON 有时仍生成 dll
        if (Test-Path "$paddleLib\paddle_inference.dll") {
            Copy-Item "$paddleLib\paddle_inference.dll" -Destination $releaseDir -Force
        }
        if (Test-Path "$paddleLib\common.dll") {
            Copy-Item "$paddleLib\common.dll" -Destination $releaseDir -Force
        }
        # 如果开启了 MKL/OneDNN，可能还需要 mkldnn.dll 或 mkl*.dll
        Get-ChildItem "$paddleLib\*.dll" | Copy-Item -Destination $releaseDir -Force
        
        Write-Output "Files prepared in $releaseDir"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: paddleocr-cpp-windows-static-build
        path: |
          PaddleOCR/deploy/cpp_infer/build/Release/
          C:\opencv_install/
          ${{ env.PADDLE_LIB_DIR }}/
        retention-days: 7

  release:
    needs: build
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
        pattern: paddleocr-cpp-windows-static-build

    - name: Zip artifacts for release
      run: |
        cd artifacts
        zip -r ../paddleocr-build-${{ github.event.inputs.version }}.zip . --exclude "*.git*"
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: PaddleOCR C++ Build ${{ github.event.inputs.version }} (Source Paddle Inference 3.2.0)
        body: |
          ## PaddleOCR C++ Windows CPU Build (Source Paddle Inference 3.2.0, PaddleOCR release/3.2)
          
          - **OpenCV**: 4.7.0 (static, with freetype/harfbuzz)
          - **Paddle Inference**: 3.2.0 (source-built, CPU/OneDNN)
          - **PaddleOCR**: release/3.2
          - **Artifacts**: ppocr.exe, DLLs, libs, headers
          
          Download `paddleocr-build-${{ github.event.inputs.version }}.zip` for deployment.
        files: paddleocr-build-${{ github.event.inputs.version }}.zip
        generate_release_notes: false
